# =============================================================================
# Deploy Gateway to Hetzner
# =============================================================================
# Triggers on push to main branch when gateway files change.
# SSHs into the Hetzner server and updates the running containers.
#
# Required Secrets:
#   - HETZNER_HOST: Server IP or hostname
#   - HETZNER_USER: SSH username (usually 'root')
#   - HETZNER_SSH_KEY: Private SSH key for authentication
#   - AR_IO_WALLET: Gateway operator wallet address
#   - OBSERVER_WALLET: Observer hot wallet address
#   - OBSERVER_WALLET_KEY: Observer wallet keyfile contents (JSON)
#
# Required Secrets (continued):
#   - ARNS_ROOT_HOST: Your domain name for ArNS routing
#
# Optional Variables:
#   - GRAPHQL_HOST: GraphQL endpoint (default: arweave.net)
#   - START_HEIGHT: Starting block height for indexing
# =============================================================================

name: Deploy Gateway

on:
  push:
    branches:
      - main
    paths:
      - 'apps/gateway/**'
      - '.github/workflows/deploy-gateway.yml'
  workflow_dispatch:
    inputs:
      force_pull:
        description: 'Force pull latest Docker images'
        required: false
        default: 'false'
        type: boolean

env:
  DEPLOY_PATH: ~/ar-io-gateway

jobs:
  deploy:
    name: Deploy to Hetzner
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory
        run: |
          ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'EOF'
            mkdir -p ${{ env.DEPLOY_PATH }}
            mkdir -p ${{ env.DEPLOY_PATH }}/wallets
          EOF

      - name: Copy gateway files
        run: |
          scp -r apps/gateway/docker-compose.yaml \
              apps/gateway/docker-compose.dev.yaml \
              apps/gateway/scripts \
              ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Generate .env file
        run: |
          ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << EOF
            cat > ${{ env.DEPLOY_PATH }}/.env << 'ENVFILE'
          # Generated by GitHub Actions on $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          # Commit: ${{ github.sha }}

          # Network Configuration
          GRAPHQL_HOST=${{ vars.GRAPHQL_HOST || 'arweave.net' }}
          GRAPHQL_PORT=443
          START_HEIGHT=${{ vars.START_HEIGHT || '0' }}

          # Gateway Identity
          AR_IO_WALLET=${{ secrets.AR_IO_WALLET }}
          OBSERVER_WALLET=${{ secrets.OBSERVER_WALLET }}
          ARNS_ROOT_HOST=${{ secrets.ARNS_ROOT_HOST || '' }}

          # Observer Configuration
          RUN_OBSERVER=${{ vars.RUN_OBSERVER || 'true' }}

          # Production Settings
          LOG_LEVEL=${{ vars.LOG_LEVEL || 'info' }}
          TRUSTED_NODE_URL=${{ vars.TRUSTED_NODE_URL || 'https://arweave.net' }}
          ENVFILE
          EOF

      - name: Write observer wallet keyfile
        run: |
          ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << EOF
            if [ -n '${{ secrets.OBSERVER_WALLET_KEY }}' ]; then
              echo '${{ secrets.OBSERVER_WALLET_KEY }}' > ${{ env.DEPLOY_PATH }}/wallets/${{ secrets.OBSERVER_WALLET }}.json
              chmod 600 ${{ env.DEPLOY_PATH }}/wallets/${{ secrets.OBSERVER_WALLET }}.json
              echo "Observer wallet keyfile written"
            else
              echo "No observer wallet key provided, skipping"
            fi
          EOF

      - name: Clean up Docker resources
        if: ${{ github.event.inputs.force_pull == 'true' || github.event_name == 'push' }}
        run: |
          ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'EOF'
            echo "=== Disk usage before cleanup ==="
            df -h /
            docker system df

            echo "=== Cleaning up unused Docker images ==="
            docker image prune -af 2>/dev/null || true

            echo "=== Disk usage after cleanup ==="
            df -h /
            docker system df
          EOF

      - name: Pull latest images
        if: ${{ github.event.inputs.force_pull == 'true' || github.event_name == 'push' }}
        run: |
          ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            docker compose pull
          EOF

      - name: Deploy containers
        run: |
          ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            docker compose up -d
          EOF

      - name: Verify deployment
        run: |
          ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            
            echo "Waiting for gateway to start..."
            sleep 10
            
            echo "Container status:"
            docker compose ps
            
            echo ""
            echo "Health check:"
            curl -s http://localhost:4000/ar-io/info || echo "Gateway not responding yet (may still be starting)"
          EOF

      - name: Deployment summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.HETZNER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
