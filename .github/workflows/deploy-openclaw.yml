# =============================================================================
# Deploy OpenClaw Agent to Dedicated Server
# =============================================================================
# Deploys the OpenClaw agent from apps/openclaw/ to its own Hetzner server.
# The agent connects to the gateway via public HTTPS endpoint and SSH.
#
# Required Secrets:
#   - OPENCLAW_HOST: OpenClaw server public IP
#   - OPENCLAW_USER: SSH username (usually 'root')
#   - OPENCLAW_SSH_KEY: Private SSH key for OpenClaw server access
#   - GATEWAY_SSH_KEY: Private SSH key for agent to access gateway
#   - ANTHROPIC_API_KEY: Claude API key
#   - OPENCLAW_GATEWAY_TOKEN: UI auth token
# Optional Secrets:
#   - OPENCLAW_KEYRING_PASSWORD: Keyring password
#   - SLACK_APP_TOKEN: Slack Socket Mode app token (xapp-...)
#   - SLACK_BOT_TOKEN: Slack bot OAuth token (xoxb-...)
#
# Required Variables:
#   - GATEWAY_PUBLIC_IP: Gateway server's public IP (for SSH access)
# =============================================================================

name: Deploy OpenClaw

on:
  push:
    branches: [main]
    paths:
      - 'apps/openclaw/**'
      - 'packages/openclaw-ario-plugin/**'
      - '.github/workflows/deploy-openclaw.yml'
  workflow_dispatch:

env:
  DEPLOY_PATH: ~/openclaw

jobs:
  deploy:
    name: Deploy to OpenClaw Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.OPENCLAW_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.OPENCLAW_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            mkdir -p ${{ env.DEPLOY_PATH }}
          EOF

      - name: Copy deployment files
        run: |
          scp -r apps/openclaw/* \
            ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Deploy nginx config
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            # Files already copied to $DEPLOY_PATH by previous step
            cp ${{ env.DEPLOY_PATH }}/nginx/clawd /etc/nginx/sites-available/clawd
            ln -sf /etc/nginx/sites-available/clawd /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx
          EOF

      - name: Write SSH key for gateway access
        env:
          GATEWAY_SSH_KEY: ${{ secrets.GATEWAY_SSH_KEY }}
        run: |
          # Write key to temp file locally (preserves newlines correctly)
          TMPKEY=$(mktemp)
          printf '%s\n' "$GATEWAY_SSH_KEY" > "$TMPKEY"
          chmod 600 "$TMPKEY"
          # Copy to remote server
          scp "$TMPKEY" ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }}:${{ env.DEPLOY_PATH }}/gateway_key
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} "chmod 600 ${{ env.DEPLOY_PATH }}/gateway_key"
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} "chown 1000:1000 ${{ env.DEPLOY_PATH }}/gateway_key"
          rm -f "$TMPKEY"

      - name: Generate .env
        run: |
          DEPLOY_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} "cat > ${{ env.DEPLOY_PATH }}/.env" << ENVFILE
          # Generated by GitHub Actions on $DEPLOY_DATE
          # Commit: ${{ github.sha }}

          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          OPENCLAW_GATEWAY_TOKEN=${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          OPENCLAW_KEYRING_PASSWORD=${{ secrets.OPENCLAW_KEYRING_PASSWORD }}
          SLACK_APP_TOKEN=${{ secrets.SLACK_APP_TOKEN }}
          SLACK_BOT_TOKEN=${{ secrets.SLACK_BOT_TOKEN }}
          ENVFILE
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} "chmod 600 ${{ env.DEPLOY_PATH }}/.env"

      - name: Validate required variables
        run: |
          if [ -z "${{ vars.GATEWAY_PUBLIC_IP }}" ]; then
            echo "Error: GATEWAY_PUBLIC_IP variable is not set"
            exit 1
          fi

      - name: Update openclaw.json with gateway config
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            set -euo pipefail
            cd ${{ env.DEPLOY_PATH }}
            PROJECT_NAME="${COMPOSE_PROJECT_NAME:-$(basename "$PWD")}"
            NETWORK_NAME="${PROJECT_NAME}_openclaw-network"
            docker network create "$NETWORK_NAME" >/dev/null 2>&1 || true
            GATEWAY_PUBLIC_IP="${{ vars.GATEWAY_PUBLIC_IP }}"
            TRUSTED_PROXY_IP="$(docker network inspect "$NETWORK_NAME" -f '{{(index .IPAM.Config 0).Gateway}}' 2>/dev/null || true)"
            if [ -z "$TRUSTED_PROXY_IP" ]; then
              TRUSTED_PROXY_IP="$(docker network inspect bridge -f '{{(index .IPAM.Config 0).Gateway}}' 2>/dev/null || true)"
            fi
            if [ -z "$TRUSTED_PROXY_IP" ]; then
              echo "Error: unable to determine trusted proxy IP"
              exit 1
            fi
            if [ ! -f openclaw.json ]; then
              echo "Error: openclaw.json not found in ${{ env.DEPLOY_PATH }}"
              exit 1
            fi
            if ! command -v python3 >/dev/null 2>&1; then
              echo "Error: python3 not found on host"
              exit 1
            fi

            export GATEWAY_PUBLIC_IP
            export TRUSTED_PROXY_IP
            python3 - << 'PY'
          import json
          import os
          from pathlib import Path

          path = Path("openclaw.json")
          data = json.loads(path.read_text())

          try:
              data["plugins"]["entries"]["openclaw-ario-plugin"]["config"]["ssh"]["host"] = os.environ["GATEWAY_PUBLIC_IP"]
          except KeyError as exc:
              raise SystemExit(f"Error: missing plugin ssh host path in openclaw.json: {exc}") from exc

          gateway = data.setdefault("gateway", {})
          existing = gateway.get("trustedProxies", [])
          if not isinstance(existing, list):
              existing = []
          merged = []
          for value in [*existing, os.environ["TRUSTED_PROXY_IP"]]:
              if value and value not in merged:
                  merged.append(value)
          gateway["trustedProxies"] = merged

          path.write_text(json.dumps(data, indent=2) + "\n")
          PY
            chmod 600 openclaw.json
            chown 1000:1000 openclaw.json
          EOF

      - name: Build and deploy containers
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}

            # Build with no cache to get latest versions
            docker compose build --no-cache

            # Deploy
            docker compose up -d
          EOF

      - name: Verify deployment
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}

            echo "Waiting for OpenClaw to start..."
            sleep 15

            echo "Container status:"
            docker compose ps

            echo ""
            echo "Health check:"
            curl -s http://localhost:18789/health || echo "OpenClaw not responding yet (may still be starting)"

            echo ""
            echo "Recent logs:"
            docker compose logs --tail=20 openclaw
          EOF

      - name: Slack diagnostics
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            set -euo pipefail
            cd ${{ env.DEPLOY_PATH }}
            set -a
            . ./.env
            set +a

            echo "Slack token presence:"
            if [ -n "${SLACK_APP_TOKEN:-}" ]; then
              echo "  SLACK_APP_TOKEN: set (length=${#SLACK_APP_TOKEN})"
            else
              echo "  SLACK_APP_TOKEN: missing"
            fi
            if [ -n "${SLACK_BOT_TOKEN:-}" ]; then
              echo "  SLACK_BOT_TOKEN: set (length=${#SLACK_BOT_TOKEN})"
            else
              echo "  SLACK_BOT_TOKEN: missing"
            fi

            echo ""
            echo "Slack API checks:"
            if [ -n "${SLACK_BOT_TOKEN:-}" ]; then
              curl -sS -H "Authorization: Bearer $SLACK_BOT_TOKEN" https://slack.com/api/auth.test \
                | python3 -c 'import json,sys; d=json.load(sys.stdin); print({"ok":d.get("ok"),"error":d.get("error"),"team":d.get("team"),"bot_id":d.get("bot_id"),"user_id":d.get("user_id")})'
              curl -sS -H "Authorization: Bearer $SLACK_BOT_TOKEN" https://slack.com/api/auth.scopes \
                | python3 -c 'import json,sys; d=json.load(sys.stdin); print({"ok":d.get("ok"),"error":d.get("error"),"scopes":d.get("scopes"),"acceptedScopes":d.get("acceptedScopes"),"needed":d.get("needed"),"provided":d.get("provided")})'
              curl -sS -H "Authorization: Bearer $SLACK_BOT_TOKEN" "https://slack.com/api/conversations.list?types=public_channel,private_channel,im,mpim&limit=200" \
                | python3 -c 'import json,sys; d=json.load(sys.stdin); chans=d.get("channels") or []; print({"ok":d.get("ok"),"error":d.get("error"),"needed":d.get("needed"),"provided":d.get("provided"),"count":len(chans)})'
            fi
            if [ -n "${SLACK_APP_TOKEN:-}" ]; then
              curl -sS -X POST -H "Authorization: Bearer $SLACK_APP_TOKEN" https://slack.com/api/apps.connections.open \
                | python3 -c 'import json,sys; d=json.load(sys.stdin); print({"ok":d.get("ok"),"error":d.get("error"),"has_url":bool(d.get("url"))})'
            fi

            echo ""
            echo "Active Slack config from openclaw.json:"
            python3 - << 'PY'
          import json
          from pathlib import Path

          cfg = json.loads(Path("openclaw.json").read_text())
          print(cfg.get("channels", {}).get("slack"))
          PY

            echo ""
            echo "OpenClaw channel status (probe):"
            docker compose exec -T openclaw npx openclaw channels status --probe < /dev/null || true

            echo ""
            echo "Slack pairing records:"
            docker compose exec -T openclaw npx openclaw pairing list slack < /dev/null || true

            echo ""
            echo "Slack-related logs (tail 300):"
            docker compose logs --tail=300 openclaw | grep -Ei "slack|socket|pair|auth|token|error|warn" || true
          EOF

      - name: Deployment summary
        run: |
          echo "## OpenClaw Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Access UI: https://clawd.agenticway.io" >> $GITHUB_STEP_SUMMARY
          echo "- View logs: See deployment documentation for SSH access" >> $GITHUB_STEP_SUMMARY
