# =============================================================================
# Deploy OpenClaw Agent to Dedicated Server
# =============================================================================
# Deploys the OpenClaw agent from apps/openclaw/ to its own Hetzner server.
# The agent connects to the gateway via public HTTPS endpoint and SSH.
#
# Required Secrets:
#   - OPENCLAW_HOST: OpenClaw server public IP
#   - OPENCLAW_USER: SSH username (usually 'root')
#   - OPENCLAW_SSH_KEY: Private SSH key for OpenClaw server access
#   - GATEWAY_SSH_KEY: Private SSH key for agent to access gateway
#   - ANTHROPIC_API_KEY: Claude API key
#   - OPENCLAW_GATEWAY_TOKEN: UI auth token
#
# Required Variables:
#   - GATEWAY_PUBLIC_IP: Gateway server's public IP (for SSH access)
# =============================================================================

name: Deploy OpenClaw

on:
  push:
    branches: [main]
    paths:
      - 'apps/openclaw/**'
      - 'packages/openclaw-ario-plugin/**'
      - '.github/workflows/deploy-openclaw.yml'
  workflow_dispatch:

env:
  DEPLOY_PATH: ~/openclaw

jobs:
  deploy:
    name: Deploy to OpenClaw Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.OPENCLAW_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.OPENCLAW_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            mkdir -p ${{ env.DEPLOY_PATH }}
          EOF

      - name: Copy deployment files
        run: |
          scp -r apps/openclaw/* \
            ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Deploy nginx config
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            # Files already copied to $DEPLOY_PATH by previous step
            cp ${{ env.DEPLOY_PATH }}/nginx/clawd /etc/nginx/sites-available/clawd
            ln -sf /etc/nginx/sites-available/clawd /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx
          EOF

      - name: Write SSH key for gateway access
        env:
          GATEWAY_SSH_KEY: ${{ secrets.GATEWAY_SSH_KEY }}
        run: |
          # Write key to temp file locally (preserves newlines correctly)
          TMPKEY=$(mktemp)
          printf '%s\n' "$GATEWAY_SSH_KEY" > "$TMPKEY"
          chmod 600 "$TMPKEY"
          # Copy to remote server
          scp "$TMPKEY" ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }}:${{ env.DEPLOY_PATH }}/gateway_key
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} "chmod 600 ${{ env.DEPLOY_PATH }}/gateway_key"
          rm -f "$TMPKEY"

      - name: Generate .env
        run: |
          DEPLOY_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} "cat > ${{ env.DEPLOY_PATH }}/.env" << ENVFILE
          # Generated by GitHub Actions on $DEPLOY_DATE
          # Commit: ${{ github.sha }}

          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          OPENCLAW_GATEWAY_TOKEN=${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          ENVFILE

      - name: Validate required variables
        run: |
          if [ -z "${{ vars.GATEWAY_PUBLIC_IP }}" ]; then
            echo "Error: GATEWAY_PUBLIC_IP variable is not set"
            exit 1
          fi

      - name: Update openclaw.json with gateway config
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            set -euo pipefail
            cd ${{ env.DEPLOY_PATH }}
            GATEWAY_PUBLIC_IP="${{ vars.GATEWAY_PUBLIC_IP }}"
            TRUSTED_PROXY_IP="$(docker network inspect openclaw-network -f '{{(index .IPAM.Config 0).Gateway}}' 2>/dev/null || docker network inspect bridge -f '{{(index .IPAM.Config 0).Gateway}}' 2>/dev/null || true)"
            if [ -z "$TRUSTED_PROXY_IP" ]; then
              echo "Error: unable to determine trusted proxy IP"
              exit 1
            fi
            if [ ! -f openclaw.json ]; then
              echo "Error: openclaw.json not found in ${{ env.DEPLOY_PATH }}"
              exit 1
            fi
            if ! command -v python3 >/dev/null 2>&1; then
              echo "Error: python3 not found on host"
              exit 1
            fi

            export GATEWAY_PUBLIC_IP
            export TRUSTED_PROXY_IP
            python3 - << 'PY'
          import json
          import os
          from pathlib import Path

          path = Path("openclaw.json")
          data = json.loads(path.read_text())

          try:
              data["plugins"]["entries"]["openclaw-ario-plugin"]["config"]["ssh"]["host"] = os.environ["GATEWAY_PUBLIC_IP"]
          except KeyError as exc:
              raise SystemExit(f"Error: missing plugin ssh host path in openclaw.json: {exc}") from exc

          gateway = data.setdefault("gateway", {})
          gateway["trustedProxies"] = [os.environ["TRUSTED_PROXY_IP"]]

          path.write_text(json.dumps(data, indent=2) + "\n")
          PY
            chmod 600 openclaw.json
          EOF

      - name: Build and deploy containers
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}

            # Build with no cache to get latest versions
            docker compose build --no-cache

            # Deploy
            docker compose up -d
          EOF

      - name: Verify deployment
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}

            echo "Waiting for OpenClaw to start..."
            sleep 15

            echo "Container status:"
            docker compose ps

            echo ""
            echo "Health check:"
            curl -s http://localhost:18789/health || echo "OpenClaw not responding yet (may still be starting)"

            echo ""
            echo "Recent logs:"
            docker compose logs --tail=20 openclaw
          EOF

      - name: Deployment summary
        run: |
          echo "## OpenClaw Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Access UI: https://clawd.agenticway.io" >> $GITHUB_STEP_SUMMARY
          echo "- View logs: See deployment documentation for SSH access" >> $GITHUB_STEP_SUMMARY
