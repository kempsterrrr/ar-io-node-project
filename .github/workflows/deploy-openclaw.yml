# =============================================================================
# Deploy OpenClaw Agent to Dedicated Server
# =============================================================================
# Deploys the OpenClaw agent from apps/openclaw/ to its own Hetzner server.
# The agent connects to the gateway via private network for API calls and SSH.
#
# Required Secrets:
#   - OPENCLAW_HOST: OpenClaw server public IP
#   - OPENCLAW_USER: SSH username (usually 'root')
#   - OPENCLAW_SSH_KEY: Private SSH key for OpenClaw server access
#   - GATEWAY_SSH_KEY: Private SSH key for agent to access gateway
#   - ANTHROPIC_API_KEY: Claude API key
#   - OPENCLAW_GATEWAY_TOKEN: UI auth token
#
# Required Variables:
#   - GATEWAY_PRIVATE_IP: Gateway's private network IP (default: 10.0.0.2)
# =============================================================================

name: Deploy OpenClaw

on:
  push:
    branches: [main]
    paths:
      - 'apps/openclaw/**'
      - 'packages/openclaw-ario-plugin/**'
      - '.github/workflows/deploy-openclaw.yml'
  workflow_dispatch:

env:
  DEPLOY_PATH: ~/openclaw

jobs:
  deploy:
    name: Deploy to OpenClaw Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.OPENCLAW_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.OPENCLAW_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            mkdir -p ${{ env.DEPLOY_PATH }}
          EOF

      - name: Copy deployment files
        run: |
          scp -r apps/openclaw/* \
            ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Write SSH key for gateway access
        env:
          GATEWAY_SSH_KEY: ${{ secrets.GATEWAY_SSH_KEY }}
        run: |
          # Write key to temp file locally (preserves newlines correctly)
          TMPKEY=$(mktemp)
          printf '%s\n' "$GATEWAY_SSH_KEY" > "$TMPKEY"
          chmod 600 "$TMPKEY"
          # Copy to remote server
          scp "$TMPKEY" ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }}:${{ env.DEPLOY_PATH }}/gateway_key
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} "chmod 600 ${{ env.DEPLOY_PATH }}/gateway_key"
          rm -f "$TMPKEY"

      - name: Generate .env
        run: |
          DEPLOY_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} "cat > ${{ env.DEPLOY_PATH }}/.env" << ENVFILE
          # Generated by GitHub Actions on $DEPLOY_DATE
          # Commit: ${{ github.sha }}

          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          OPENCLAW_GATEWAY_TOKEN=${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          ENVFILE

      - name: Update openclaw.json with gateway IP
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            GATEWAY_IP="${{ vars.GATEWAY_PRIVATE_IP || '10.0.0.2' }}"

            # Update the gateway URL and SSH host in openclaw.json
            cat > openclaw.json << CONFIGFILE
          {
            "gateway": {
              "mode": "local",
              "auth": {
                "mode": "token"
              },
              "controlUi": {
                "enabled": true
              }
            },
            "plugins": {
              "entries": {
                "ario-gateway": {
                  "enabled": true,
                  "config": {
                    "gatewayUrl": "http://${GATEWAY_IP}:4000",
                    "timeout": 30000,
                    "ssh": {
                      "host": "${GATEWAY_IP}",
                      "user": "root",
                      "keyPath": "/home/node/.ssh/gateway_key"
                    }
                  }
                }
              }
            }
          }
          CONFIGFILE
          EOF

      - name: Build and deploy containers
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}

            # Build with no cache to get latest versions
            docker compose build --no-cache

            # Deploy
            docker compose up -d
          EOF

      - name: Verify deployment
        run: |
          ssh ${{ secrets.OPENCLAW_USER }}@${{ secrets.OPENCLAW_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}

            echo "Waiting for OpenClaw to start..."
            sleep 15

            echo "Container status:"
            docker compose ps

            echo ""
            echo "Health check:"
            curl -s http://localhost:18789/health || echo "OpenClaw not responding yet (may still be starting)"

            echo ""
            echo "Recent logs:"
            docker compose logs --tail=20 openclaw-gateway
          EOF

      - name: Deployment summary
        run: |
          echo "## OpenClaw Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Access UI: https://clawd.agenticway.io" >> $GITHUB_STEP_SUMMARY
          echo "- View logs: See deployment documentation for SSH access" >> $GITHUB_STEP_SUMMARY
