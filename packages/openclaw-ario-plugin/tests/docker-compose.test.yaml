# =============================================================================
# OpenClaw Plugin Integration Test Environment
# =============================================================================
# Usage: docker compose -f tests/docker-compose.test.yaml up --build --abort-on-container-exit
# =============================================================================

services:
  # Mock AR.IO Gateway for testing
  gateway-mock:
    image: node:22-slim
    working_dir: /app
    volumes:
      - ./mock-server.cjs:/app/mock-server.cjs:ro
    command: node mock-server.cjs
    ports:
      - "4000:4000"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:4000/ar-io/info').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

  # OpenClaw with plugin for testing
  openclaw:
    build:
      context: ..
      dockerfile: Dockerfile
    environment:
      - ANTHROPIC_API_KEY=test-key
      - OPENCLAW_GATEWAY_TOKEN=test-token
    volumes:
      - ./openclaw.test.json:/home/node/.openclaw/openclaw.json:ro
    depends_on:
      gateway-mock:
        condition: service_healthy
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:18789/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  # Test runner
  test-runner:
    image: node:22-slim
    working_dir: /tests
    volumes:
      - ./:/tests
    environment:
      - GATEWAY_URL=http://gateway-mock:4000
      - OPENCLAW_URL=http://openclaw:18789
    depends_on:
      openclaw:
        condition: service_healthy
    networks:
      - test-network
    command: >
      sh -c "
        npm install && npm test
      "

networks:
  test-network:
    driver: bridge
