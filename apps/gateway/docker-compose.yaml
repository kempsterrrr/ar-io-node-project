# =============================================================================
# AR.IO Gateway - Production Configuration
# =============================================================================
# Based on the official ar-io-node docker-compose.yaml
# For local development, use: docker compose -f docker-compose.yaml -f docker-compose.dev.yaml up
# For production, use: docker compose up -d
# =============================================================================

services:
  envoy:
    image: ghcr.io/ar-io/ar-io-envoy:${ENVOY_IMAGE_TAG:-latest}
    restart: unless-stopped
    ports:
      - "${GATEWAY_PORT:-3000}:3000"
    environment:
      - LOG_LEVEL=${ENVOY_LOG_LEVEL:-info}
      - TVAL_AR_IO_HOST=core
      - TVAL_AR_IO_PORT=4000
      - TVAL_OBSERVER_HOST=core
      - TVAL_OBSERVER_PORT=5050
      - TVAL_TRUSTED_NODE_HOST=${TRUSTED_NODE_HOST:-arweave.net}
      - TVAL_TRUSTED_NODE_PORT=${TRUSTED_NODE_PORT:-443}
      - TVAL_FALLBACK_NODE_HOST=${FALLBACK_NODE_HOST:-}
      - TVAL_FALLBACK_NODE_PORT=${FALLBACK_NODE_PORT:-1984}
      - TVAL_GRAPHQL_HOST=core
      - TVAL_GRAPHQL_PORT=4000
      - TVAL_DATASETS_HOST=core
      - TVAL_DATASETS_PORT=4000
      - TVAL_ARNS_ROOT_HOST=${ARNS_ROOT_HOST:-}
      - TVAL_ARWEAVE_POST_DRY_RUN=${ARWEAVE_POST_DRY_RUN:-false}
    depends_on:
      - core
    networks:
      - ar-io-network

  core:
    image: ghcr.io/ar-io/ar-io-core:${CORE_IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-simple}
      - GRAPHQL_HOST=${GRAPHQL_HOST:-arweave.net}
      - GRAPHQL_PORT=${GRAPHQL_PORT:-443}
      - START_HEIGHT=${START_HEIGHT:-}
      - ARNS_ROOT_HOST=${ARNS_ROOT_HOST:-}
      - AR_IO_WALLET=${AR_IO_WALLET:-}
      - ADMIN_API_KEY=${ADMIN_API_KEY:-}
      - TRUSTED_NODE_URL=${TRUSTED_NODE_URL:-https://arweave.net}
      - RUN_OBSERVER=${RUN_OBSERVER:-false}
      - OBSERVER_WALLET=${OBSERVER_WALLET:-}
    volumes:
      - ${DATA_PATH:-./data}:/app/data
      - ./wallets:/app/wallets:ro
    networks:
      - ar-io-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/ar-io/info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  ar-io-network:
    driver: bridge
    name: ar-io-network
