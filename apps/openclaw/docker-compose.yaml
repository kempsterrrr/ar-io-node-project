# =============================================================================
# OpenClaw Agent Deployment (Separate Server)
# =============================================================================
# Runs OpenClaw on its own server, connected to the gateway via public endpoints.
#
# Prerequisites:
#   - Gateway accessible at public URL (https://ario.agenticway.io)
#   - SSH key for gateway access (gateway_key in this directory)
#
# Setup:
#   1. Copy .env.example to .env and fill in secrets
#   2. Place gateway SSH private key as ./gateway_key
#   3. docker compose up -d
#
# Update:
#   docker compose build --no-cache && docker compose up -d
#
# Access:
#   - Local: http://localhost:18789 (via nginx proxy on host)
#   - Public: https://clawd.agenticway.io (protected by basic auth)
# =============================================================================

services:
  openclaw:
    build: .
    image: openclaw-ario:local
    container_name: openclaw-gateway
    restart: unless-stopped
    ports:
      - "127.0.0.1:18789:18789"  # Loopback only, host nginx handles public
    environment:
      NODE_ENV: production
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      OPENCLAW_KEYRING_PASSWORD: ${OPENCLAW_KEYRING_PASSWORD:-}
    volumes:
      # Persist workspace only (agent artifacts, memories)
      # DO NOT mount over /home/node/.openclaw - it wipes the extensions installed during build
      - openclaw-workspace:/home/node/.openclaw/workspace
      # Persist device pairing approvals
      - openclaw-devices:/home/node/.openclaw/devices
      # Config from host (generated by deploy workflow)
      # NOTE: openclaw.json must be chmod 600 on the host
      - ./openclaw.json:/home/node/.openclaw/openclaw.json:ro
      # SSH key for gateway access (must be chmod 600)
      - ./gateway_key:/home/node/.ssh/gateway_key:ro
    networks:
      - openclaw-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

networks:
  openclaw-network:
    driver: bridge

volumes:
  openclaw-workspace:
  openclaw-devices:
